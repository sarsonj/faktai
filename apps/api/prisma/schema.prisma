generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DefaultVariableSymbolType {
  ico
  custom
}

enum InvoiceStatus {
  draft
  issued
  paid
  cancelled
}

enum PaymentMethod {
  bank_transfer
}

enum TaxClassification {
  domestic_standard
  domestic_reverse_charge
  eu_service
  eu_goods
  export_third_country
  exempt_without_credit
}

enum TaxReportType {
  vat_return
  summary_statement
  control_statement
}

enum TaxPeriodType {
  month
  quarter
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  passwordHash        String
  isActive            Boolean              @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  sessions            UserSession[]
  passwordResetTokens PasswordResetToken[]
  subject             Subject?
  pdfExports          PdfExportMetadata[]
  taxReportRuns       TaxReportRun[]
}

model UserSession {
  id               String    @id @default(uuid())
  userId           String
  sessionTokenHash String    @unique
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subject {
  id                         String                    @id @default(uuid())
  userId                     String                    @unique
  firstName                  String
  lastName                   String
  businessName               String?
  ico                        String                    @db.VarChar(8)
  dic                        String?
  isVatPayer                 Boolean
  vatRegistrationDate        DateTime?
  street                     String
  city                       String
  postalCode                 String
  countryCode                String                    @default("CZ") @db.VarChar(2)
  bankAccountPrefix          String?
  bankAccountNumber          String
  bankCode                   String                    @db.VarChar(4)
  defaultVariableSymbolType  DefaultVariableSymbolType
  defaultVariableSymbolValue String?
  defaultDueDays             Int                       @default(14)
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  user                       User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices                   Invoice[]
  numberSequences            InvoiceNumberSequence[]
  taxReportRuns              TaxReportRun[]
}

model Invoice {
  id                  String        @id @default(uuid())
  subjectId           String
  status              InvoiceStatus @default(draft)
  invoiceNumber       String?
  variableSymbol      String
  issueDate           DateTime
  taxableSupplyDate   DateTime
  dueDate             DateTime
  paymentMethod       PaymentMethod @default(bank_transfer)
  taxClassification   TaxClassification?
  customerName        String
  customerIco         String?
  customerDic         String?
  customerStreet      String
  customerCity        String
  customerPostalCode  String
  customerCountryCode String        @default("CZ") @db.VarChar(2)
  supplierSnapshot    Json?
  note                String?
  totalWithoutVat     Decimal       @db.Decimal(15, 2)
  totalVat            Decimal       @db.Decimal(15, 2)
  totalWithVat        Decimal       @db.Decimal(15, 2)
  pdfVersion          Int           @default(0)
  pdfPayloadHash      String?
  paidAt              DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  subject             Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  items               InvoiceItem[]
  pdfExports          PdfExportMetadata[]
  taxReportEntries    TaxReportRunEntry[]

  @@unique([subjectId, invoiceNumber])
  @@index([subjectId, issueDate(sort: Desc)])
  @@index([subjectId, dueDate])
  @@index([subjectId, status])
  @@index([subjectId, taxableSupplyDate])
}

model InvoiceItem {
  id                  String   @id @default(uuid())
  invoiceId           String
  position            Int
  description         String
  quantity            Decimal  @db.Decimal(15, 3)
  unit                String   @db.VarChar(20)
  unitPrice           Decimal  @db.Decimal(15, 2)
  vatRate             Int
  lineTotalWithoutVat Decimal  @db.Decimal(15, 2)
  lineVatAmount       Decimal  @db.Decimal(15, 2)
  lineTotalWithVat    Decimal  @db.Decimal(15, 2)
  invoice             Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId, position])
}

model InvoiceNumberSequence {
  id           String   @id @default(uuid())
  subjectId    String
  periodYear   Int
  currentValue Int      @default(0)
  subject      Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, periodYear])
}

model PdfExportMetadata {
  id               String   @id @default(uuid())
  invoiceId        String
  exportedAt       DateTime @default(now())
  exportedByUserId String
  pdfVersion       Int
  payloadHash      String
  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [exportedByUserId], references: [id], onDelete: Cascade)

  @@index([invoiceId, exportedAt])
}

model TaxReportRun {
  id                String          @id @default(uuid())
  subjectId         String
  reportType        TaxReportType
  periodType        TaxPeriodType
  periodYear        Int
  periodValue       Int
  runVersion        Int
  datasetHash       String
  generatedByUserId String
  generatedAt       DateTime        @default(now())
  subject           Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  generatedByUser   User            @relation(fields: [generatedByUserId], references: [id], onDelete: Cascade)
  entries           TaxReportRunEntry[]

  @@index([subjectId, reportType, periodType, periodYear, periodValue, generatedAt(sort: Desc)])
}

model TaxReportRunEntry {
  id                     String      @id @default(uuid())
  runId                  String
  invoiceId              String
  invoiceUpdatedAtSnapshot DateTime
  run                    TaxReportRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  invoice                Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([runId, invoiceId])
}
